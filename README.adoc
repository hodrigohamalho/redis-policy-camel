
= Redis Policy para 3scale com Apache Camel
:author: Rodrigo Ramalho
:revdate: 2025-04-17
:icons: font

Este repositÃ³rio contÃ©m uma implementaÃ§Ã£o de uma Custom Policy para o Red Hat 3scale, utilizando Apache Camel para realizar verificaÃ§Ã£o de autorizaÃ§Ã£o com base em valores armazenados no Redis.

== ğŸ“¦ Componentes

- Apache Camel (baseado em Fuse)
- Redis (como cache de controle)
- OpenShift (deployment)
- 3scale APIcast (como gateway principal)

== âš™ï¸ Funcionamento

Esta policy expÃµe um endpoint HTTP REST que:

1. Recebe uma requisiÃ§Ã£o com uma chave (`?key=xyz`)
2. Consulta o Redis para verificar se a chave existe
3. Autoriza ou bloqueia a requisiÃ§Ã£o com base no resultado da consulta

== ğŸ” AutenticaÃ§Ã£o no Redis

A conexÃ£o com Redis Ã© autenticada usando senha (`REDIS_PASSWORD`), que Ã© passada via Secret no OpenShift.

== ğŸš€ Deploy no OpenShift

1. Substitua `your_secure_password` no arquivo `deployment.redis-policy-camel.yaml` com sua senha real.
2. Suba a imagem para um registro acessÃ­vel:
+
[source,bash]
----
podman build -t redis-policy-camel:latest -f Dockerfile.camel.redis.policy .
podman push redis-policy-camel:latest quay.io/seu_usuario/redis-policy-camel:latest
----
3. Aplique o deployment no OpenShift:
+
[source,bash]
----
oc apply -f deployment.redis-policy-camel.yaml
----

== ğŸ”— IntegraÃ§Ã£o com o 3scale

1. Acesse o **Admin Portal** do 3scale
2. VÃ¡ atÃ© `Integration > APIcast > Policies`
3. Adicione uma Camnel policy customizada que redirecione chamadas para:
+
`http://redis-policy-camel.policy.svc.cluster.local/policy/check?key={some-key}`

== ğŸ§ª Testando

1. Testar o Proxy: salvando o IP no Redis

ğŸ”¹ RequisiÃ§Ã£o simulada passando o parÃ¢metro someParam=cliente123 e o IP no header:

+
[source,bash]
----
curl -i -X GET "http://<ROTA_OPENSHIFT>/proxy?someParam=cliente123" \
  -H "X-Forwarded-For: 203.0.113.77"
----

â¡ï¸ Isso vai salvar no Redis:

+
[source,bash]
----
Chave: user-ip:cliente123
Valor: 203.0.113.77
----

ğŸ§ª 2. Listar todas as chaves salvas no Redis (modo admin)

ğŸ”¹ Ver todas as chaves do tipo user-ip:*:

+
[source,bash]
----
curl -i http://<ROTA_OPENSHIFT>/admin/keys
----

â¡ï¸ Esperado (exemplo):
+
`["user-ip:cliente123", "user-ip:cliente456"]`

ğŸ§ª 3. Obter o valor de uma chave especÃ­fica

ğŸ”¹ Consultar a chave user-ip:cliente123:

+
[source,bash]
----
curl -i http://<ROTA_OPENSHIFT>/admin/keys/cliente123
----

â¡ï¸ Esperado:
+ 
`Valor: 203.0.113.77` 

== ğŸ“ Estrutura do repositÃ³rio

[source,text]
----
.
â”œâ”€â”€ Dockerfile.camel.redis.policy
â”œâ”€â”€ deployment.redis-policy-camel.yaml
â”œâ”€â”€ src/
â”‚   â””â”€â”€ main/java/com/redhat/threescale/policy/RedisPolicyRoute.java
----
